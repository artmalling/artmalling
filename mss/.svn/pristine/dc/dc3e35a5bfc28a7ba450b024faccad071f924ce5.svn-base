<?xml version="1.0" encoding="euc-kr"?>
<!-- XML 버전 1.0을 사용하며 encoding 타입은 ‘euc-kr’로 한다.-->
<!--
 * 작 성 자 : 오형규
 * 회 사 명 : 한국후지쯔
 * 작 성 일 : 2010.03.09
 * 변 경 일 : 
 * 변경내용 : 
 * 개    요 :  조직별 약속 현황
 -->
<service name="/mpro205.mp">
    <!-- 해피콜 미이행 조회 HEAD -->
    <gauce name="H_SEL_MASTER"> 
        <column colName="STR_CD" colType="TB_STRING" size="2" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="STRNM" colType="TB_STRING" size="40" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />TAKE_DT
        <column colName="TAKE_DT" colType="TB_STRING" size="10" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="PROM_TYPE" colType="TB_STRING" size="2" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="PROM_TYPE_NM" colType="TB_STRING" size="40" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="DELI_RECEIVE" colType="TB_INT" size="5" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="DELI_CALL" colType="TB_INT" size="5" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="HAPPYOK" colType="TB_INT" size="5" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="HAPPYNO" colType="TB_INT" size="5" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="CNT1" colType="TB_INT" size="5" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="DAY01" colType="TB_INT" size="5" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="DAY02" colType="TB_INT" size="5" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="DAY03" colType="TB_INT" size="5" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="DAY04" colType="TB_INT" size="5" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="CNT2" colType="TB_INT" size="5" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />        
    </gauce>
    <!-- 해피콜미이행조회 상세팝업 헤드 -->
    <gauce name="H_SEL_POP_MASTER">
        <column colName="TAKE_DT"           colType="TB_STRING" size="8" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="STR_CD"            colType="TB_STRING" size="2" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="TAKE_SEQ"          colType="TB_STRING" size="5" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="TAKE_USER_ID"      colType="TB_STRING" size="10" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="TAKE_USER_NM"      colType="TB_STRING" size="10" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="CUST_NM"           colType="TB_STRING" size="40" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="POST_NO"           colType="TB_STRING" size="6" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="CUST_POST_SEQ"     colType="TB_STRING" size="5" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="ADDR"              colType="TB_STRING" size="100" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="DTL_ADDR"          colType="TB_STRING" size="100" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="MOBILE_PH1"        colType="TB_STRING" size="32" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="MOBILE_PH2"        colType="TB_STRING" size="32" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="MOBILE_PH3"        colType="TB_STRING" size="32" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="HOME_PH1"          colType="TB_STRING" size="32" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="HOME_PH2"          colType="TB_STRING" size="32" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="HOME_PH3"          colType="TB_STRING" size="32" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="FRST_PROM_DT"      colType="TB_STRING" size="8" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="FRST_PROM_HH"      colType="TB_STRING" size="2" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="FRST_PROM_MM"      colType="TB_STRING" size="2" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="LAST_PROM_DT"      colType="TB_STRING" size="8" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="LAST_PROM_HH"      colType="TB_STRING" size="2" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="LAST_PROM_MM"      colType="TB_STRING" size="2" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="PROM_TYPE"         colType="TB_STRING" size="2" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="PROM_DTL"          colType="TB_STRING" size="4000" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="DELI_TYPE"         colType="TB_STRING" size="2" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="DELI_STR"          colType="TB_STRING" size="2" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="PUMBUN_CD"         colType="TB_STRING" size="6" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="PUMBUN_NM"         colType="TB_STRING" size="40" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="ORG_CD"            colType="TB_STRING" size="10" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="ORG_NM"            colType="TB_STRING" size="40" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="SKU_NM"            colType="TB_STRING" size="40" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="IN_DELI_DT"        colType="TB_STRING" size="8" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="SMS_YN"            colType="TB_STRING" size="1" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="COUR_CUST_NM"      colType="TB_STRING" size="40" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="COUR_POST_NO"      colType="TB_STRING" size="6" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="COUR_POST_SEQ"     colType="TB_INT" size="5" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="COUR_ADDR"         colType="TB_STRING" size="100" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="COUR_DTL_ADDR"     colType="TB_STRING" size="100" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="COUR_MOBILE_PH1"   colType="TB_STRING" size="32" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="COUR_MOBILE_PH2"   colType="TB_STRING" size="32" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="COUR_MOBILE_PH3"   colType="TB_STRING" size="32" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="COUR_HOME_PH1"     colType="TB_STRING" size="32" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="COUR_HOME_PH2"     colType="TB_STRING" size="32" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="COUR_HOME_PH3"     colType="TB_STRING" size="32" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="COUR_COMP_NM"      colType="TB_STRING" size="40" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="COUR_SEND_NO"      colType="TB_STRING" size="40" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="PROC_STAT"         colType="TB_STRING" size="1" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="PROC_STAT_NM"      colType="TB_STRING" size="40" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="HAPPY_CALL_YN"     colType="TB_STRING" size="1" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="OVERDAY"         colType="TB_STRING" size="2" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
    </gauce>
    
    <!-- 해피콜미이행조회  -->
    <query name="SEL_HAPPYCALL">
        <![CDATA[
		SELECT A.STR_CD AS STR_CD
             , STR_NAME AS STR_NAME			                             
             , A.TAKE_DT AS TAKE_DT
			 , A.PROM_TYPE AS PROM_TYPE 
			 , COM.FN_GET_COMM_NAME('D','M021', A.PROM_TYPE ) AS PROM_TYPE_NM
			 , SUM(A.DELI_RECEIVE)   AS DELI_RECEIVE
			 , SUM(A.DELI_CALL)      AS DELI_CALL
			 , SUM(A.HAPPYOK)        AS HAPPYOK
			 , SUM(A.HAPPYNO)        AS HAPPYNO
			 , SUM(A.HAPPYOK+ A.HAPPYNO ) AS CNT1
			 , SUM(CASE WHEN (A.HAPPYNO > 0 AND A.OVERDAY <= 1) THEN 1 ELSE 0 END) AS DAY01
			 , SUM(CASE WHEN (A.HAPPYNO > 0 AND A.OVERDAY = 2) THEN 1 ELSE 0 END) AS DAY02
			 , SUM(CASE WHEN (A.HAPPYNO > 0 AND A.OVERDAY = 3) THEN 1 ELSE 0 END) AS DAY03
			 , SUM(CASE WHEN (A.HAPPYNO > 0 AND A.OVERDAY > 3) THEN 1 ELSE 0 END) AS DAY04
			 , SUM(A.HAPPYNO) AS CNT2
		  FROM (
		        SELECT A.STR_CD AS STR_CD
                     , C.STR_NAME STR_NAME
                     , A.PROM_TYPE 
	                 , A.TAKE_DT   
	                 , A.TAKE_SEQ
	                 , (CASE A.DELI_TYPE WHEN  '01' THEN 1 ELSE 0 END) DELI_RECEIVE
	                 , (CASE A.DELI_TYPE WHEN  '02' THEN 1 ELSE 0 END) DELI_CALL
	                 , (CASE WHEN (SELECT COUNT(1)
	                                 FROM MSS.MP_HAPPYCALLMGR B 
	                                WHERE B.TAKE_SEQ = A.TAKE_SEQ
	                                  AND B.STR_CD = A.STR_CD
	                                  AND B.TAKE_DT = A.TAKE_DT) > 0 THEN 1 ELSE 0 END) AS HAPPYOK
	                 , 1 - (CASE WHEN (SELECT COUNT(1) 
	                                     FROM MSS.MP_HAPPYCALLMGR B 
	                                    WHERE B.TAKE_SEQ = A.TAKE_SEQ
	                                      AND B.STR_CD = A.STR_CD
	                                      AND B.TAKE_DT = A.TAKE_DT) > 0 THEN 1 ELSE 0 END) AS HAPPYNO
	                 , TRUNC(SYSDATE - TO_DATE(A.LAST_PROM_DT, 'YYYYMMDD')) AS OVERDAY 
		          FROM MSS.MP_PROMISECERT A, DPS.PC_STRMST C 
		         WHERE A.STR_CD = C.STR_CD
		           AND A.STR_CD LIKE ? || '%'
		           AND A.TAKE_DT >= ? AND A.TAKE_DT <= ?
		           AND A.PROC_STAT IN ('3', '4')
		           AND A.STR_CD IN (SELECT DISTINCT STR_CD FROM COM.V_MYORG 
                                                      WHERE USER_ID = ? AND ORG_FLAG = '1')
		        ) A
	    GROUP BY A.STR_CD, A.PROM_TYPE, STR_NAME, A.TAKE_DT
		ORDER BY A.STR_CD, A.TAKE_DT                     
        ]]>
    </query>
    
    <!-- 해피콜미이행조회 상세팝업 -->
    <query name="SEL_HAPPYCALLPOPUP">
        <![CDATA[
        SELECT TAKE_DT                      
             , STR_CD                     
             , TAKE_SEQ                   
             , TAKE_USER_ID               
             , COM.FN_GET_USER_NAME(TAKE_USER_ID) AS TAKE_USER_NM                       
             , CUST_NM                    
             , POST_NO                    
             , CUST_POST_SEQ              
             , ADDR                       
             , DTL_ADDR                   
             , DCS.SC_Crypto_FUN('DEC', MOBILE_PH1) AS MOBILE_PH1                 
             , DCS.SC_Crypto_FUN('DEC', MOBILE_PH2) AS MOBILE_PH2                 
             , DCS.SC_Crypto_FUN('DEC', MOBILE_PH3) AS MOBILE_PH3                
             , DCS.SC_Crypto_FUN('DEC', HOME_PH1) AS HOME_PH1                   
             , DCS.SC_Crypto_FUN('DEC', HOME_PH2) AS HOME_PH2                   
             , DCS.SC_Crypto_FUN('DEC', HOME_PH3) AS HOME_PH3                   
             , FRST_PROM_DT               
             , SUBSTR(FRST_PROM_TIME, 0,2) AS FRST_PROM_HH               
             , SUBSTR(FRST_PROM_TIME, 3,2) AS FRST_PROM_MM               
             , LAST_PROM_DT                
             , SUBSTR(LAST_PROM_TIME, 0,2) AS LAST_PROM_HH                
             , SUBSTR(LAST_PROM_TIME, 3,2) AS LAST_PROM_MM                
             , PROM_TYPE                  
             , PROM_DTL                   
             , DELI_TYPE                  
             , DELI_STR                   
             , PUMBUN_CD                  
             , (SELECT PUMBUN_NAME FROM DPS.PC_PBNMST WHERE PUMBUN_CD = A.PUMBUN_CD) AS PUMBUN_NM                  
             , COM.FN_GET_ORG_INFO(A.TAKE_USER_ID, 'CODE') AS ORG_CD                     
             , COM.FN_GET_ORG_INFO(A.TAKE_USER_ID, 'NAME') AS ORG_NM                     
             , SKU_NM                     
             , IN_DELI_DT                 
             , SMS_YN                     
             , COUR_CUST_NM               
             , COUR_POST_NO               
             , COUR_POST_SEQ              
             , COUR_ADDR                  
             , COUR_DTL_ADDR              
             , DCS.SC_Crypto_FUN('DEC', COUR_MOBILE_PH1) AS COUR_MOBILE_PH1            
             , DCS.SC_Crypto_FUN('DEC', COUR_MOBILE_PH2) AS COUR_MOBILE_PH2            
             , DCS.SC_Crypto_FUN('DEC', COUR_MOBILE_PH3) AS COUR_MOBILE_PH3            
             , DCS.SC_Crypto_FUN('DEC', COUR_HOME_PH1) AS COUR_HOME_PH1              
             , DCS.SC_Crypto_FUN('DEC', COUR_HOME_PH2) AS COUR_HOME_PH2              
             , DCS.SC_Crypto_FUN('DEC', COUR_HOME_PH3) AS COUR_HOME_PH3              
             , COUR_COMP_NM               
             , COUR_SEND_NO               
             , PROC_STAT   
             , COM.FN_GET_COMM_NAME('D','M024',PROC_STAT) AS PROC_STAT_NM   
             , (SELECT COUNT(*) 
                  FROM MSS.MP_HAPPYCALLMGR B 
                 WHERE A.TAKE_DT = B.TAKE_DT 
                   AND A.STR_CD = B.STR_CD 
                   AND A.TAKE_SEQ = B.TAKE_SEQ) AS HAPPY_CALL_YN
             , TRUNC(SYSDATE - TO_DATE(A.LAST_PROM_DT, 'YYYYMMDD')) AS OVERDAY 
          FROM MSS.MP_PROMISECERT A
         WHERE NOT EXISTS(
                           SELECT B.STR_CD
                                , B.TAKE_SEQ
                                , B.TAKE_DT 
                             FROM MSS.MP_HAPPYCALLMGR B
                            WHERE A.STR_CD = B.STR_CD
                              AND A.TAKE_SEQ = B.TAKE_SEQ
                              AND A.TAKE_DT = B.TAKE_DT
                          )
           AND A.STR_CD = ?
           AND A.TAKE_DT = ?
           AND A.PROC_STAT IN ('3', '4')
           AND A.STR_CD IN (SELECT DISTINCT STR_CD FROM COM.V_MYORG WHERE USER_ID = ? AND ORG_FLAG = '1')                 
        ]]>
    </query>    
    
</service>