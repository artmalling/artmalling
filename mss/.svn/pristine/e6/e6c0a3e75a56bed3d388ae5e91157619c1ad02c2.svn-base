<?xml version="1.0" encoding="euc-kr"?>
<!-- XML 버전 1.0을 사용하며 encoding 타입은 ‘euc-kr’로 한다.-->
<!--
 * 작 성 자 : 정지인
 * 회 사 명 : 한국후지쯔
 * 작 성 일 : 2010.12.12
 * 변 경 일 : 
 * 변경내용 : 
 * 개    요 :  개발팀에서 기입해주세요
 -->
<service name="/mgif211.mg">
    <!-- 점내 불출신청 확정 마스터  -->
    <gauce name="H_MASTER"> 
        <column colName="STR_CD"			colType="TB_STRING"  size="2"  dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="STR_NAME"			colType="TB_STRING"  size="40" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="ORG_CD"			colType="TB_STRING"  size="10" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="ORG_NAME"			colType="TB_STRING"  size="40" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="EVENT_CD"			colType="TB_STRING"  size="12" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="EVENT_NAME"		colType="TB_STRING"  size="40" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="POUT_TYPE"			colType="TB_STRING"  size="2"  dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="POUT_NAME"			colType="TB_STRING"  size="40" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="POUT_REQ_DT"		colType="TB_STRING"  size="8"  dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="POUT_REQ_SLIP_NO"	colType="TB_STRING"	 size="6"  dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="REQ_QTY"			colType="TB_DECIMAL" size="7"  dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="TOT_AMT"			colType="TB_DECIMAL" size="12" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="CONF_FLAG"			colType="TB_STRING"  size="1"  dec="0" keyType="TB_NORMAL" roundMode="ROUND" /> 
    </gauce>
    
    <!-- 점내 불출신청 확정 디테일  -->
    <gauce name="H_DETAIL"> 
        <column colName="POUT_TYPE"         colType="TB_STRING"  size="1"  dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="POUT_REQ_DT"       colType="TB_STRING"  size="8"  dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="STR_CD"            colType="TB_STRING"  size="4"  dec="2" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="POUT_REQ_SLIP_NO"	colType="TB_STRING"  size="6"  dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="POUT_REQ_SEQ_NO"	colType="TB_STRING"  size="3"  dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="GIFT_TYPE_CD"		colType="TB_STRING"  size="4"  dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="GIFT_TYPE_NAME"	colType="TB_STRING"  size="40" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="ISSUE_TYPE"		colType="TB_STRING"  size="1"  dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="GIFT_AMT_TYPE"		colType="TB_STRING"  size="4"  dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="GIFT_AMT_NAME"		colType="TB_STRING"  size="40" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="REQ_QTY"			colType="TB_DECIMAL" size="7"  dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="REQ_AMT"			colType="TB_DECIMAL" size="12" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="CONF_QTY"			colType="TB_DECIMAL" size="7"  dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
    </gauce>
    
    <!-- 점내 불출신청 확정 디테일  -->
    <gauce name="H_CONF"> 
		<column colName="GIFT_TYPE_CD"      colType="TB_STRING"  size="4"  dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="GIFT_TYPE_NAME"    colType="TB_STRING"  size="40" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="ISSUE_TYPE"        colType="TB_STRING"  size="1"  dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="GIFT_AMT_TYPE"     colType="TB_STRING"  size="4"  dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="GIFT_AMT_NAME"     colType="TB_STRING"  size="40" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="GIFTCERT_AMT"      colType="TB_DECIMAL" size="12" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="EVENT_CD"          colType="TB_STRING"  size="11" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="GIFT_S_NO"			colType="TB_STRING"  size="18" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="GIFT_E_NO"         colType="TB_STRING"  size="18" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="CONF_QTY"          colType="TB_DECIMAL" size="7"  dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="CONF_AMT"          colType="TB_DECIMAL" size="12" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="POUT_TYPE"         colType="TB_STRING"  size="2"  dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="CONF_DT"           colType="TB_STRING"  size="8"  dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="POUT_REQ_DT"       colType="TB_STRING"  size="8"  dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="STR_CD"            colType="TB_STRING"  size="2"  dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="POUT_REQ_SLIP_NO"  colType="TB_STRING"  size="6"  dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="POUT_REQ_SEQ_NO"   colType="TB_STRING"  size="3"  dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
    </gauce>
    
    <!-- 지점출고 확정 마스터  -->
    <gauce name="H_CNT"> 
        <column colName="GIFTCARD_CNT"      colType="TB_DECIMAL" size="12" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="GIFTCARD_ALL_CNT"  colType="TB_DECIMAL" size="12" dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
    </gauce>
    
     <!-- 점내 불출신청 확정 마스터  -->
    <query name="SEL_MASTER">
        <![CDATA[
        SELECT VA.STR_CD,   --점코드
		       IA.STR_NAME, --점명
		       VA.ORG_CD,   --신청부서
		       IB.ORG_NAME, --부서명
               VA.EVENT_CD, -- 사은품코드
               ID.EVENT_NAME, -- 사은품명
		       VA.POUT_TYPE, --불출유형
		       IC.COMM_NAME1 AS POUT_NAME, --불출유형명
		       VA.POUT_REQ_DT, --신청일자
		       VA.POUT_REQ_SLIP_NO, --신청순
		       VA.REQ_QTY,          --신청수량
		       VA.TOT_AMT,          --신청금액
		       VA.CONF_FLAG        --확정구분 
		  FROM (SELECT TA.STR_CD, 
		               TA.ORG_CD, 
		               TA.POUT_TYPE, 
		               TA.POUT_REQ_DT, 
		               TA.POUT_REQ_SLIP_NO, 
		               SUM(TA.REQ_QTY) AS REQ_QTY, 
		               SUM(TA.REQ_QTY * TB.GIFTCERT_AMT) AS TOT_AMT,
		               TA.CONF_FLAG, 
		               TA.CONF_DT,
		               TA.EVENT_CD
		          FROM MSS.MG_POUTREQ TA,
		               MSS.MG_GIFTAMTMST TB
		         WHERE TA.GIFT_TYPE_CD = TB.GIFT_TYPE_CD
		           AND TA.ISSUE_TYPE = TB.ISSUE_TYPE
		           AND TA.GIFT_AMT_TYPE = TB.GIFT_AMT_TYPE
		           AND TA.STR_CD = ?
		           AND TA.ORG_CD LIKE ?||'%'
		           AND TA.POUT_REQ_DT BETWEEN ? AND ?
		           AND TA.POUT_TYPE LIKE ?||'%'
		           AND TA.CONF_FLAG = '9'
		         GROUP BY TA.STR_CD, 
		                  TA.ORG_CD, 
		                  TA.POUT_TYPE, 
		                  TA.POUT_REQ_DT, 
		                  TA.POUT_REQ_SLIP_NO,
		                  TA.CONF_FLAG, 
		                  TA.CONF_DT,
		                  TA.EVENT_CD
		                  ) VA,
		       DPS.PC_STRMST IA,
		       DPS.PC_ORGMST IB,
		       COM.TC_COMMCODE IC,
               DPS.PC_EVTMST ID
		 WHERE VA.STR_CD = IA.STR_CD
		   AND VA.ORG_CD = IB.ORG_CD
		   AND VA.POUT_TYPE = IC.COMM_CODE
           AND VA.EVENT_CD = ID.EVENT_CD(+)
		   AND IC.COMM_PART = 'M014'
		   AND IC.SYS_PART = 'D'
		 ORDER BY VA.POUT_REQ_DT DESC,
		          VA.POUT_REQ_SLIP_NO,
		          VA.STR_CD,
		          VA.ORG_CD
        ]]>
    </query>  
    
    <!-- 점내 불출신청 확정 금종별 조회   -->
    <query name="SEL_DETAIL">
        <![CDATA[
        SELECT TA.POUT_TYPE,
               TA.POUT_REQ_DT,
               TA.STR_CD,
               TA.POUT_REQ_SLIP_NO,
               TA.POUT_REQ_SEQ_NO,
               TA.GIFT_TYPE_CD,
               TC.GIFT_TYPE_NAME,
               TA.ISSUE_TYPE,
               TA.GIFT_AMT_TYPE,
               TB.GIFT_AMT_NAME,
               TA.REQ_QTY,
               TA.REQ_QTY * TB.GIFTCERT_AMT AS REQ_AMT,
               0 AS CONF_QTY
          FROM MSS.MG_POUTREQ TA,
               MSS.MG_GIFTAMTMST TB,
               MSS.MG_GIFTTPMST TC                 
         WHERE TA.GIFT_TYPE_CD = TB.GIFT_TYPE_CD
           AND TA.ISSUE_TYPE = TB.ISSUE_TYPE
           AND TA.GIFT_AMT_TYPE = TB.GIFT_AMT_TYPE  
           AND TA.GIFT_TYPE_CD = TC.GIFT_TYPE_CD
		   AND TA.STR_CD = ?
		   AND TA.POUT_REQ_DT = ?
		   AND TA.POUT_REQ_SLIP_NO = ?
      ORDER BY TA.GIFT_AMT_TYPE
        ]]>
    </query>  
    
    <!-- 점내 불출신청  확정 내역  -->
    <query name="SEL_CONF">
        <![CDATA[
            SELECT TA.GIFT_TYPE_CD --상품권 종류 코드
                  ,TC.GIFT_TYPE_NAME
			      ,TA.ISSUE_TYPE --발행형태
			      ,TA.GIFT_AMT_TYPE --금종
			      ,TB.GIFT_AMT_NAME --금종명
			      ,TA.GIFTCERT_AMT --상품권 금액
			      ,IA.EVENT_CD       --행사코드
			      ,'' AS GIFT_S_NO --상품권 시작번호
			      ,'' AS GIFT_E_NO --상품권 종료번호
			      ,0 AS CONF_QTY --확정수량
			      ,0 AS CONF_AMT --확정금액
			      ,'' AS POUT_TYPE --불출유형
			      ,'' AS CONF_DT --확정일자       
			      ,'' AS POUT_REQ_DT --불출 일자 
			      ,'' AS STR_CD --점
			      ,'' AS POUT_REQ_SLIP_NO --불출전표번호
			      ,'' AS POUT_REQ_SEQ_NO --불출신청순번
			  FROM MSS.MG_GIFTMST TA,
			       MSS.MG_GIFTAMTMST TB,
			       (SELECT TA.GIFT_TYPE_CD,
			               TA.ISSUE_TYPE,
			               TA.GIFT_AMT_TYPE,
			               TA.EVENT_CD
			          FROM MSS.MG_POUTREQ TA
			         WHERE TA.STR_CD = ?
			           AND TA.POUT_REQ_DT = ?
			           AND TA.POUT_REQ_SLIP_NO = ?) IA
			           , MSS.MG_GIFTTPMST TC
			 WHERE TA.GIFT_TYPE_CD = TB.GIFT_TYPE_CD
			   AND TA.ISSUE_TYPE = TB.ISSUE_TYPE
			   AND TA.GIFT_AMT_TYPE = TB.GIFT_AMT_TYPE
			   AND TA.GIFT_TYPE_CD = IA.GIFT_TYPE_CD
			   AND TA.ISSUE_TYPE = IA.ISSUE_TYPE
			   AND TA.GIFT_AMT_TYPE = IA.GIFT_AMT_TYPE
			   AND TA.GIFT_TYPE_CD = TC.GIFT_TYPE_CD
			   AND TA.STAT_FLAG = '03'
			   AND TA.ACDT_FLAG = 'N'
			   AND TA.GIFTCARD_NO = ?
			   AND TA.IN_STR = ?
			   AND TA.IN_DT <= ?
        ]]>
    </query>  
    
    <!-- 점내 불출 전표번호 조회 -->
    <query name="SEL_SLIP_NO">
        <![CDATA[
        SELECT LPAD(MSS.SQ_MG_POUTREQCONF.NEXTVAL,6,'0') AS SLIP_NO FROM DUAL
        ]]>
    </query> 
    
    <!-- 유효수량 체크 -->
    <query name="SEL_CNT">
        <![CDATA[
	    SELECT SUM(GIFTCARD_CNT) AS GIFTCARD_CNT
	         , SUM(GIFTCARD_ALL_CNT) AS GIFTCARD_ALL_CNT
	  
	     FROM (
	           SELECT COUNT(*) AS GIFTCARD_CNT
	                 , 0 AS GIFTCARD_ALL_CNT
	              FROM MSS.MG_GIFTMST TA,
	                   MSS.MG_GIFTAMTMST TB,
	                   (SELECT TA.STR_CD,
	                           TA.GIFT_TYPE_CD,
	                           TA.ISSUE_TYPE,
	                           TA.GIFT_AMT_TYPE,
	                           TA.EVENT_CD
	                      FROM MSS.MG_POUTREQ TA
	                     WHERE TA.STR_CD = ?
	                       AND TA.POUT_REQ_DT = ?
	                       AND TA.POUT_REQ_SLIP_NO = ? ) IA
	                       , MSS.MG_GIFTTPMST TC
	             WHERE TA.GIFT_TYPE_CD = TB.GIFT_TYPE_CD
	               AND TA.ISSUE_TYPE = TB.ISSUE_TYPE
	               AND TA.GIFT_AMT_TYPE = TB.GIFT_AMT_TYPE
	               AND TA.GIFT_TYPE_CD = IA.GIFT_TYPE_CD
	               AND TA.ISSUE_TYPE = IA.ISSUE_TYPE
	               AND TA.GIFT_AMT_TYPE = IA.GIFT_AMT_TYPE
	               AND TA.GIFT_TYPE_CD = TC.GIFT_TYPE_CD
	               AND TA.STAT_FLAG = '03'
	               AND TA.ACDT_FLAG = 'N'
	               AND TA.IN_STR = IA.STR_CD
	               AND TA.IN_DT <= ?
	               AND TA.GIFTCARD_NO BETWEEN ? AND ?
	            UNION ALL
	            SELECT 0 AS GIFTCARD_CNT
	                 , COUNT(*) AS GIFTCARD_ALL_CNT
	              FROM MSS.MG_GIFTMST TA,
	                   MSS.MG_GIFTAMTMST TB,
	                   (SELECT TA.STR_CD,
	                           TA.GIFT_TYPE_CD,
	                           TA.ISSUE_TYPE,
	                           TA.GIFT_AMT_TYPE,
	                           TA.EVENT_CD
	                      FROM MSS.MG_POUTREQ TA
	                     WHERE TA.STR_CD = ?
	                       AND TA.POUT_REQ_DT = ?
	                       AND TA.POUT_REQ_SLIP_NO = ?) IA
	                       , MSS.MG_GIFTTPMST TC
	             WHERE TA.GIFT_TYPE_CD = TB.GIFT_TYPE_CD
	               AND TA.ISSUE_TYPE = TB.ISSUE_TYPE
	               AND TA.GIFT_AMT_TYPE = TB.GIFT_AMT_TYPE
	               AND TA.GIFT_TYPE_CD = IA.GIFT_TYPE_CD
	               AND TA.ISSUE_TYPE = IA.ISSUE_TYPE
	               AND TA.GIFT_AMT_TYPE = IA.GIFT_AMT_TYPE
	               AND TA.GIFT_TYPE_CD = TC.GIFT_TYPE_CD
	               AND TA.ACDT_FLAG = 'N'
	               AND TA.IN_STR = IA.STR_CD
	               AND TA.IN_DT <= ?
	               AND TA.GIFTCARD_NO BETWEEN ? AND ? )
        ]]>
    </query> 
    
    <!-- 점내 불출 확정 저장 -->
    <query name="INS_MG_POUTREQCONF">
        <![CDATA[
        INSERT INTO MSS.MG_POUTREQCONF (
		                                CONF_DT
		                                ,STR_CD
		                                ,CONF_SLIP_NO
		                                ,CONF_SEQ_NO
		                                ,POUT_REQ_SLIP_NO
		                                ,POUT_REQ_SEQ_NO
		                                ,POUT_REQ_DT
		                                ,GIFT_TYPE_CD
		                                ,ISSUE_TYPE
		                                ,GIFT_AMT_TYPE
		                                ,CONF_QTY
		                                ,CONF_AMT
		                                ,GIFT_S_NO
		                                ,GIFT_E_NO
		                                ,POUT_FLAG
		                                ,POUT_TYPE
		                                ,EVENT_CD
		                                ,REG_ID
		                                ,REG_DATE
		                                ,MOD_ID
		                                ,MOD_DATE
		                                ,POUT_PART_CD
		                                )
		                       VALUES ( 
		                                ?
		                               ,?
		                               ,?
		                               ,(SELECT NVL(MAX(IA.SEQNO), 1)
		                                   FROM (
		                                          SELECT /*+ INDEX_DESC (TA PK_MG_POUTREQCONF) */
		                                                 CONF_SEQ_NO + 1 AS SEQNO
		                                            FROM MSS.MG_POUTREQCONF TA
		                                           WHERE TA.CONF_DT = ?
		                                             AND TA.STR_CD = ?
		                                             AND TA.CONF_SLIP_NO = ?
		                                             AND ROWNUM = 1
		                                         ) IA 
		                                 )
		                                ,?
		                                ,?
		                                ,?
		                                ,?
		                                ,?
		                                ,?
		                                ,?
		                                ,?
		                                ,?
		                                ,?
		                                ,'1'
		                                ,?
		                                ,?
		                                ,?
		                                ,SYSDATE
		                                ,?
		                                ,SYSDATE
		                                ,?
		                                )
        ]]>
    </query> 
    
    <!-- 점내 불출 확정  -->
    <query name="UPD_MG_POUTREQ">
        <![CDATA[
         UPDATE MSS.MG_POUTREQ
           SET CONF_FLAG = '1'
             , CONF_DT = ?
             , MOD_ID = ? 
             , MOD_DATE = SYSDATE
         WHERE POUT_REQ_DT = ?
           AND STR_CD = ?
           AND POUT_REQ_SLIP_NO = ? 
        ]]>
    </query> 
    
    <!-- 상품권마스터 상태값 수정  -->
    <query name="UPD_MG_GIFTMST">
        <![CDATA[
         UPDATE MSS.MG_GIFTMST
           SET STAT_FLAG = CASE  WHEN ? = '1' OR ? = '4' THEN '04' ELSE '05' END 
             , POUT_DT = ?
             , POUT_EMP_ID = ?
             , POUT_FLAG = '1'
             , POUT_TYPE = ?
             , MOD_ID = ? 
             , MOD_DATE = SYSDATE
             , POUT_PART_CD = ?
        WHERE GIFTCARD_NO BETWEEN ? AND ?
          AND STAT_FLAG = '03'
          AND ACDT_FLAG = 'N'
          AND IN_STR = ?
          AND IN_DT <= ?
        ]]>
    </query> 
</service>