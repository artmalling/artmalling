<?xml version="1.0" encoding="euc-kr"?>
<!-- XML 버전 1.0을 사용하며 encoding 타입은 ‘euc-kr’로 한다.-->
<!--
 * 작 성 자 : 박종은
 * 회 사 명 : 한국후지쯔
 * 작 성 일 : 2010.04.08
 * 변 경 일 : 
 * 변경내용 : 
 * 개    요 :  
 -->
<service name="/psal524.ps">

    <gauce name="H_SEL_MASTER"> 
   		<column colName="CHECK_FLAG"		colType="TB_STRING" size="1"   dec="0"    keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="STR_CD"			colType="TB_STRING" size="2"   dec="0"    keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="SALE_DT"			colType="TB_STRING" size="8"   dec="0"    keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="POS_NO"			colType="TB_STRING" size="4"   dec="0"    keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="PUMBUN_CD"			colType="TB_STRING" size="6"   dec="0"    keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="PUMBUN_NAME"		colType="TB_STRING" size="40"   dec="0"    keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="PUMMOK_CD"			colType="TB_STRING" size="8"   dec="0"    keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="PUMMOK_NAME"       colType="TB_STRING" size="40"   dec="0"    keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="EVENT_CD"			colType="TB_STRING" size="11"  dec="0"    keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="EVENT_NAME"        colType="TB_STRING" size="40"  dec="0"    keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="EVENT_FLAG"      colType="TB_STRING" size="2"   dec="0"    keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="EVENT_RATE"      colType="TB_STRING" size="2"   dec="0"    keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="MG_RATE"         colType="TB_DECIMAL" size="5"   dec="2"    keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="ORG_CD"          colType="TB_STRING" size="10"	dec="0"		 keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="FLOOR"           colType="TB_STRING" size="2"		dec="0"		 keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="VEN_CD"          colType="TB_STRING" size="6"		dec="0"		 keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="SALE_QTY"			colType="TB_DECIMAL" size="7"		dec="0"		 keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="TOT_SALE_AMT"    colType="TB_DECIMAL" size="13"	dec="0"		 keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="VAT_AMT"         colType="TB_DECIMAL" size="9"		dec="0"		 keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="REDU_AMT"        colType="TB_DECIMAL" size="13"	dec="0"		 keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="DC_AMT"          colType="TB_DECIMAL" size="13"	dec="0"		 keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="NORM_SALE_AMT"   colType="TB_DECIMAL" size="13"	dec="0"		 keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="NET_SALE_AMT"    colType="TB_DECIMAL" size="13"	dec="0"		 keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="SALE_PROF_AMT"   colType="TB_DECIMAL" size="13"	dec="0"		 keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="CUST_CNT"        colType="TB_DECIMAL" size="7"		dec="0"		 keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="REP_PUMBUN_CD"   colType="TB_STRING" size="6"		dec="0"		 keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="BUYER_CD"        colType="TB_STRING" size="6"		dec="0"		 keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="CHAR_SM"         colType="TB_STRING" size="6"		dec="0"		 keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="SPS_SALE_QTY"    colType="TB_DECIMAL" size="9"		dec="0"		 keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="SPS_SALE_AMT"    colType="TB_DECIMAL" size="9"		dec="0"		 keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="SAL_COST_PRC"    colType="TB_DECIMAL" size="13"	dec="0"		 keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="REG_DATE"        colType="TB_STRING" size="50"	dec="0"		 keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="REG_ID"          colType="TB_STRING" size="10"	dec="0"		 keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="MOD_DATE"        colType="TB_STRING" size="50"	dec="0"		 keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="MOD_ID"          colType="TB_STRING" size="10"  dec="0"		 keyType="TB_NORMAL" roundMode="ROUND" /> 
    	<column colName="TAX_FLAG"          colType="TB_STRING" size="1"  dec="0"		 keyType="TB_NORMAL" roundMode="ROUND" /> 
    	<column colName="BIZ_TYPE"          colType="TB_STRING" size="1"  dec="0"		 keyType="TB_NORMAL" roundMode="ROUND" /> 
    	<column colName="SKU_FLAG"          colType="TB_STRING" size="1"  dec="0"		 keyType="TB_NORMAL" roundMode="ROUND" /> 
		<column colName="OCCUR_FLAG_C"      colType="TB_STRING" size="1"   dec="0"    keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="OCCUR_FLAG_N"      colType="TB_STRING" size="1"   dec="0"    keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="MOD_EVENT_FLAG_N"  colType="TB_STRING" size="2"		dec="0"		 keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="MG_APP_DT_N"       colType="TB_STRING" size="8"		dec="0"		 keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="MOD_MG_RATE_N"     colType="TB_DECIMAL" size="5"		dec="2"		 keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="SALE_QTY_N"       colType="TB_DECIMAL" size="7"		dec="0"		 keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="TOT_SALE_AMT_N"    colType="TB_DECIMAL" size="13"	dec="0"		 keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="VAT_AMT_N"         colType="TB_DECIMAL" size="9"		dec="0"		 keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="REDU_AMT_N"        colType="TB_DECIMAL" size="13"	dec="0"		 keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="DC_AMT_N"          colType="TB_DECIMAL" size="13"	dec="0"		 keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="NORM_SALE_AMT_N"   colType="TB_DECIMAL" size="13"	dec="0"		 keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="NET_SALE_AMT_N"    colType="TB_DECIMAL" size="13"	dec="0"		 keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="SALE_PROF_AMT_N"   colType="TB_DECIMAL" size="13"	dec="0"		 keyType="TB_NORMAL" roundMode="ROUND" />
		<column colName="MG_RATE_CHECK"     colType="TB_STRING" size="1"	dec="0"		 keyType="TB_NORMAL" roundMode="ROUND" />
    </gauce>
    

    
     <gauce name="H_SEL_MG_RATE"> 
		<column colName="MOD_MG_RATE"         colType="TB_DECIMAL" size="5"		dec="2"	   keyType="TB_NORMAL" roundMode="ROUND" />
     </gauce>
    <!-- 쿼리는 전부 대문자 -->
   <query name="SEL_MASTER">        
        <![CDATA[
            SELECT 'F'              AS CHECK_FLAG
                  ,DPP.STR_CD       AS STR_CD
			      ,DPP.SALE_DT      AS SALE_DT
			      ,DPP.POS_NO       AS POS_NO
			      ,DPP.PUMBUN_CD    AS PUMBUN_CD
			      ,PBN.PUMBUN_NAME  AS PUMBUN_NAME
			      ,DPP.PUMMOK_CD    AS PUMMOK_CD
			      ,PMK.PUMMOK_NAME  AS PUMMOK_NAME
			      ,DPP.EVENT_CD     AS EVENT_CD
			      ,EVT.EVENT_NAME   AS EVENT_NAME
			      ,DPP.EVENT_FLAG   AS EVENT_FLAG
			      ,DPP.EVENT_RATE   AS EVENT_RATE
			      ,DPP.MG_RATE      AS MG_RATE
			      ,DPP.ORG_CD       AS ORG_CD
			      ,DPP.FLOOR        AS FLOOR
			      ,DPP.VEN_CD       AS VEN_CD
			      ,DPP.SALE_QTY     AS SALE_QTY
			      ,DPP.TOT_SALE_AMT AS TOT_SALE_AMT
			      ,DPP.VAT_AMT         AS VAT_AMT
			      ,DPP.REDU_AMT     AS REDU_AMT
			      ,DPP.DC_AMT       AS DC_AMT
			      ,DPP.NORM_SALE_AMT   AS NORM_SALE_AMT 
                  ,DPP.NET_SALE_AMT    AS NET_SALE_AMT  
                  ,DPP.SALE_PROF_AMT   AS SALE_PROF_AMT 
                  ,DPP.CUST_CNT     AS CUST_CNT
			      ,DPP.REP_PUMBUN_CD AS REP_PUMBUN_CD
			      ,DPP.BUYER_CD      AS BUYER_CD
			      ,DPP.CHAR_SM       AS CHAR_SM
			      ,DPP.SPS_SALE_QTY  AS SPS_SALE_QTY
			      ,DPP.SPS_SALE_AMT  AS SPS_SALE_AMT
			      ,DPP.SAL_COST_PRC    AS SAL_COST_PRC  
                  ,DPP.REG_DATE        AS REG_DATE      
                  ,DPP.REG_ID          AS REG_ID        
                  ,DPP.MOD_DATE        AS MOD_DATE      
                  ,DPP.MOD_ID          AS MOD_ID  
                  ,PBN.TAX_FLAG      AS TAX_FLAG
			      ,PBN.BIZ_TYPE      AS BIZ_TYPE
			      ,PBN.SKU_FLAG      AS SKU_FLAG   
			      ,'1'               AS OCCUR_FLAG_N
			      ,'0'               AS OCCUR_FLAG_N
			      ,''                AS MOD_EVENT_FLAG_N
			      ,DPP.SALE_DT       AS MG_APP_DT_N
			      ,''                AS MOD_MG_RATE_N
			      ,DPP.SALE_QTY      AS SALE_QTY_N
			      ,DPP.TOT_SALE_AMT  AS TOT_SALE_AMT_N
			      ,DPP.VAT_AMT       AS VAT_AMT_N
			      ,DPP.REDU_AMT      AS REDU_AMT_N
			      ,DPP.DC_AMT        AS DC_AMT_N
			      ,DPP.NORM_SALE_AMT AS NORM_SALE_AMT_N
			      ,DPP.NET_SALE_AMT  AS NET_SALE_AMT_N
			      ,0                 AS SALE_PROF_AMT_N
			      ,''                AS MG_RATE_CHECK 
			FROM DPS.PS_DAYPBNPOS DPP
			    ,DPS.PC_PBNMST PBN
			    ,DPS.PC_PMKMST PMK
			    ,DPS.PC_EVTMST EVT
			    ,DPS.PC_STRPBN HIS
			WHERE DPP.PUMBUN_CD = PBN.PUMBUN_CD
			AND   DPP.PUMMOK_CD = PMK.PUMMOK_CD
			AND   DPP.EVENT_CD  = EVT.EVENT_CD
            AND   DPP.PUMBUN_CD = HIS.PUMBUN_CD
            AND   DPP.ORG_CD    = HIS.SALE_ORG_CD
			AND   PBN.BIZ_TYPE IN ('2','3')
			AND   DPP.STR_CD = ?
			AND   SUBSTR(HIS.SALE_ORG_CD,3,2) LIKE ? || '%'
			AND   SUBSTR(HIS.SALE_ORG_CD,5,2) LIKE ? || '%'
			AND   SUBSTR(HIS.SALE_ORG_CD,7,2) LIKE ? || '%'
			AND   DPP.SALE_DT BETWEEN ? AND ? 
			AND   DPP.PUMBUN_CD LIKE ? || '%'
			AND   (DPP.SALE_QTY <> 0 OR DPP.TOT_SALE_AMT <> 0)
			
        ]]>        
    </query>
    

	<query name="SEL_SEQ">        
	  <![CDATA[
	  	SELECT NVL(MAX(SEQ),0)+1 AS MAX_SEQ
	  	FROM DPS.PS_DAYPBNPOSMOD
	  	WHERE 1 = 1
	  	AND STR_CD          = ?
			AND SALE_DT         = ?
			AND POS_NO          = ?
			AND PUMBUN_CD       = ?
			AND PUMMOK_CD       = ?
			AND EVENT_CD        = ?
			AND EVENT_FLAG      = ?
			AND EVENT_RATE      = ?
			AND MG_RATE         = ?
	  	
       ]]>        
    </query>
    
    <query name="SEL_MG_RATE">        
	  <![CDATA[
	  	SELECT CASE WHEN EVENT_CD = '00000000000' THEN NORM_MG_RATE ELSE EVENT_MG_RATE END AS MOD_MG_RATE 
		  FROM DPS.PC_MARGINMST
		  WHERE STR_CD = ?
		  AND   PUMBUN_CD = ?
		  AND   EVENT_FLAG = ?
		  AND   EVENT_RATE = ?
		  AND   EVENT_CD = ?
		  AND   ? BETWEEN APP_S_DT AND APP_E_DT
		
	  	
       ]]>        
    </query>
    
    <query name="SEL_MG_RATE_SKU">        
	  <![CDATA[
	   	 SELECT NORM_MG_RATE AS MOD_MG_RATE 
		   FROM DPS.PC_MARGINMST
	 	  WHERE STR_CD = ?
		    AND PUMBUN_CD = ?
		    AND EVENT_FLAG = ?
		    AND EVENT_RATE = ?
		    AND EVENT_CD = '00000000000'
		    AND ? BETWEEN APP_S_DT AND APP_E_DT
       ]]>        
    </query>
    
    <query name="INS_DETAIL">        
	  <![CDATA[
	  	INSERT INTO DPS.PS_DAYPBNPOSMOD ( STR_CD          
                                ,SALE_DT         
                                ,POS_NO          
                                ,PUMBUN_CD       
                                ,PUMMOK_CD       
                                ,EVENT_CD        
                                ,EVENT_FLAG      
                                ,EVENT_RATE      
                                ,MG_RATE         
                                ,SEQ             
                                ,OCCUR_FLAG      
                                ,MG_APP_DT       
                                ,MOD_EVENT_FLAG  
                                ,MOD_MG_RATE     
                                ,ORG_CD          
                                ,FLOOR           
                                ,VEN_CD          
                                ,SALE_QTY        
                                ,TOT_SALE_AMT    
                                ,VAT_AMT         
                                ,REDU_AMT        
                                ,DC_AMT          
                                ,NORM_SALE_AMT   
                                ,NET_SALE_AMT    
                                ,SALE_PROF_AMT   
                                ,CUST_CNT        
                                ,REP_PUMBUN_CD   
                                ,BUYER_CD        
                                ,CHAR_SM         
                                ,SPS_SALE_QTY    
                                ,SPS_SALE_AMT    
                                ,SAL_COST_PRC    
                                ,REG_DATE        
                                ,REG_ID          
                                ,MOD_DATE        
                                ,MOD_ID          
                              ) SELECT   STR_CD                                                                                
                                        ,SALE_DT                                                                               
                                        ,POS_NO                                                                                
                                        ,PUMBUN_CD                                                                             
                                        ,PUMMOK_CD                                                                             
                                        ,EVENT_CD                                                                              
                                        ,EVENT_FLAG                                                                            
                                        ,EVENT_RATE                                                                            
                                        ,MG_RATE                                                                               
                                        ,?    -- SEQ                                                               
                                        ,?    -- OCCUR_FLAG                                                                               
                                        ,?    -- MG_APP_DT                                                                   
                                        ,?    -- MOD_EVENT_FLAG                                                                      
                                        ,?    -- MG_RATE                                                                 
                                        ,ORG_CD                                                                                
                                        ,FLOOR                                                                                 
                                        ,VEN_CD                                                                                
                                        ,?    -- SALE_QTY                                                                                 
                                        ,?    -- TOT_SALE_AMT                                                                                 
                                        ,?    -- VAT_AMT 
                                           
                                        ,?    -- REDU_AMT                                                                    
                                        ,?    -- DC_AMT                                                                            
                                        ,?    -- NORM_SALE_AMT                                                                           
                                        ,?    -- NET_SALE_AMT 
                                                                                               
                                        ,?    -- SALE_PROF_AMT
                                                              
                                                              
                                        ,CUST_CNT                                                                              
                                        ,REP_PUMBUN_CD                                                                         
                                        ,BUYER_CD                                                                              
                                        ,CHAR_SM                                                                               
                                        ,SPS_SALE_QTY                                                                          
                                        ,SPS_SALE_AMT                                                                          
                                        ,SAL_COST_PRC                                                                          
                                        ,SYSDATE                                                                               
                                        ,?                                                                                     
                                        ,SYSDATE                                                                               
                                        ,?                                                                                     

                                FROM DPS.PS_DAYPBNPOS
                                WHERE 1 = 1
                                AND STR_CD          = ?
                                AND SALE_DT         = ?
                                AND POS_NO          = ?
                                AND PUMBUN_CD       = ?
                                AND PUMMOK_CD       = ?
                                AND EVENT_CD        = ?
                                AND EVENT_FLAG      = ?
                                AND EVENT_RATE      = ?
                                AND MG_RATE         = ?
	   ]]>        
    </query>
    
     <query name="INS_PS_DAYPBNPOSMODHIS">        
	  <![CDATA[
	  	INSERT INTO DPS.PS_DAYPBNPOSMODHIS
		SELECT 
		 A.STR_CD          
		,A.SALE_DT         
		,A.POS_NO          
		,A.PUMBUN_CD       
		,A.PUMMOK_CD       
		,A.EVENT_CD        
		,A.EVENT_FLAG      
		,A.EVENT_RATE      
		,A.MG_RATE         
		,B.SEQ             
		,A.ORG_CD          
		,A.FLOOR           
		,A.VEN_CD          
		,A.SALE_QTY        
		,A.TOT_SALE_AMT    
		,A.VAT_AMT         
		,A.REDU_AMT        
		,A.DC_AMT          
		,A.NORM_SALE_AMT   
		,A.NET_SALE_AMT    
		,A.SALE_PROF_AMT   
		,A.CUST_CNT        
		,A.REP_PUMBUN_CD   
		,A.BUYER_CD        
		,A.CHAR_SM         
		,A.SPS_SALE_QTY    
		,A.SPS_SALE_AMT    
		,A.SAL_COST_PRC    
		,A.REG_DATE        
		,A.REG_ID          
		,A.MOD_DATE        
		,A.MOD_ID          
		FROM DPS.PS_DAYPBNPOS A
		    ,DPS.PS_DAYPBNPOSMOD B
		WHERE A.STR_CD     = B.STR_CD
		  AND A.SALE_DT    = B.SALE_DT
		  AND A.POS_NO     = B.POS_NO
		  AND A.PUMBUN_CD  = B.PUMBUN_CD
		  AND A.PUMMOK_CD  = B.PUMMOK_CD
		  AND A.EVENT_CD   = B.EVENT_CD
		  AND A.EVENT_FLAG = B.EVENT_FLAG
		  AND A.EVENT_RATE = B.EVENT_RATE
		  AND A.MG_RATE    = B.MG_RATE
		  AND B.OCCUR_FLAG = '1'
		  AND B.SEQ        = ?
		  AND A.STR_CD     = ?
		  AND A.SALE_DT    = ?
		  AND A.POS_NO     = ?
		  AND A.PUMBUN_CD  = ?
		  AND A.PUMMOK_CD  = ?
		  AND A.EVENT_CD   = ?
		  AND A.EVENT_FLAG = ?
		  AND A.EVENT_RATE = ?
		  AND A.MG_RATE    = ?
	    ]]>        
    </query>
    
    <!-- 일마감 완료상태인 리스트 조회 -->
    <query name="SEL_DCLOSE_CHECK">
        <![CDATA[
            SELECT CLOSE_YN
              FROM DPS.PC_DCLOSE
             WHERE STR_CD          = ?
               AND CLOSE_TASK_FLAG = 'PSAL'
               AND CLOSE_UNIT_FLAG = '21'
               AND CLOSE_DT        = ?
               AND CLOSE_YN        = 'Y'
        ]]>
    </query>
</service>