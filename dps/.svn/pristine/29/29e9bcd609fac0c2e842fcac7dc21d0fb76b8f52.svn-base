<?xml version="1.0" encoding="euc-kr"?>
<!-- XML 버전 1.0을 사용하며 encoding 타입은 ‘euc-kr’로 한다.-->
<!--
 * 작 성 자 : 
 * 회 사 명 : 한국후지쯔
 * 작 성 일 : 2010.02.15
 * 변 경 일 : 
 * 변경내용 : 
 * 개    요 :  개발팀에서 기입해주세요
 -->
<service name="/pord510.po">
   <gauce name="H_MASTER"> 
        <column colName="CHECK1"              colType="TB_STRING"    size="1"   dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="STR_CD"              colType="TB_STRING"    size="2"   dec="0" keyType="TB_NORMAL" roundMode="ROUND" /> 
        <column colName="OFFER_YM"            colType="TB_STRING"    size="6"   dec="0" keyType="TB_NORMAL" roundMode="ROUND" /> 
        <column colName="OFFER_SEQ_NO"        colType="TB_DECIMAL"   size="5"   dec="0" keyType="TB_NORMAL" roundMode="ROUND" /> 
        <column colName="OFFER_DT"            colType="TB_STRING"    size="8"   dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="OFFER_SHEET_NO"      colType="TB_STRING"    size="30"  dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="BL_NO"               colType="TB_STRING"    size="40"  dec="0" keyType="TB_NORMAL" roundMode="ROUND" /> 
        <column colName="PUMBUN_CD"           colType="TB_STRING"    size="6"   dec="0" keyType="TB_NORMAL" roundMode="ROUND" /> 
        <column colName="PUMBUN_NM"           colType="TB_STRING"    size="40"  dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="VEN_CD"              colType="TB_STRING"    size="6"   dec="0" keyType="TB_NORMAL" roundMode="ROUND" /> 
        <column colName="VEN_NM"              colType="TB_STRING"    size="40"  dec="0" keyType="TB_NORMAL" roundMode="ROUND" /> 
        <column colName="CURRENCY_CD"         colType="TB_STRING"    size="3"   dec="0" keyType="TB_NORMAL" roundMode="ROUND" /> 
        <column colName="CLOSE_FLAG"          colType="TB_STRING"    size="1"   dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="EXPNC_CLOSE_FLAG"    colType="TB_STRING"    size="1"   dec="0" keyType="TB_NORMAL" roundMode="ROUND" /> 
        <column colName="COST_CLOSE_FLAG"     colType="TB_STRING"    size="1"   dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="TMP_COST_CLOSE_FLAG" colType="TB_STRING"    size="1"   dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="SKU_FLAG"            colType="TB_STRING"    size="1"   dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="SKU_TYPE"            colType="TB_STRING"    size="1"   dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="OFFER_TOT_QTY"       colType="TB_DECIMAL"   size="7"   dec="0" keyType="TB_NORMAL" roundMode="ROUND" /> 
        <column colName="OFFER_TOT_AMT"       colType="TB_DECIMAL"   size="15"  dec="2" keyType="TB_NORMAL" roundMode="ROUND" /> 
        <column colName="EXP_SUP_AMT"         colType="TB_DECIMAL"   size="13"  dec="0" keyType="TB_NORMAL" roundMode="ROUND" /> 
        <column colName="EXP_VAT_AMT"         colType="TB_DECIMAL"   size="13"  dec="0" keyType="TB_NORMAL" roundMode="ROUND" /> 
        <column colName="CHK_TOT_QTY"         colType="TB_DECIMAL"   size="8"   dec="1" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="NOT_IN_QTY"          colType="TB_DECIMAL"   size="7"   dec="1" keyType="TB_NORMAL" roundMode="ROUND" /> 
        <column colName="CHK_EXC_TAMT"        colType="TB_DECIMAL"   size="15"  dec="2" keyType="TB_NORMAL" roundMode="ROUND" /> 
        <column colName="CHK_COST_TAMT"       colType="TB_DECIMAL"   size="13"  dec="0" keyType="TB_NORMAL" roundMode="ROUND" />         
    </gauce>
    
     <gauce name="H_DETAIL"> 
        <column colName="STR_CD"              colType="TB_STRING"    size="2"   dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="OFFER_YM"            colType="TB_STRING"    size="6"   dec="0" keyType="TB_NORMAL" roundMode="ROUND" /> 
        <column colName="OFFER_SEQ_NO"        colType="TB_DECIMAL"   size="5"   dec="0" keyType="TB_NORMAL" roundMode="ROUND" /> 
        <column colName="SLIP_NO"             colType="TB_STRING"    size="12"  dec="0" keyType="TB_NORMAL" roundMode="ROUND" /> 
        <column colName="SKU_CD"              colType="TB_STRING"    size="13"  dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="SKU_NM"              colType="TB_STRING"    size="40"  dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="STYLE_CD"            colType="TB_STRING"    size="54"  dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="COLOR_CD"            colType="TB_STRING"    size="3"   dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="SIZE_CD"             colType="TB_STRING"    size="3"   dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="MODEL_NO"            colType="TB_STRING"    size="24"  dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="CHK_QTY"             colType="TB_DECIMAL"   size="7"   dec="0" keyType="TB_NORMAL" roundMode="ROUND" /> 
        <column colName="CHK_EXC_AMT"         colType="TB_DECIMAL"   size="15"  dec="2" keyType="TB_NORMAL" roundMode="ROUND" /> 
        <column colName="CHK_COST_AMT"        colType="TB_DECIMAL"   size="13"  dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="ASS_EXPENCE_AMT"     colType="TB_DECIMAL"   size="13"  dec="0" keyType="TB_NORMAL" roundMode="ROUND" /> 
        <column colName="ASS_COST_PRC"        colType="TB_DECIMAL"   size="13"  dec="0" keyType="TB_NORMAL" roundMode="ROUND" /> 
        <column colName="CONF_EXPENCE_AMT"    colType="TB_DECIMAL"   size="13"  dec="0" keyType="TB_NORMAL" roundMode="ROUND" /> 
        <column colName="CONF_COST_PRC"       colType="TB_DECIMAL"   size="13"  dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
    </gauce>    
    
     <gauce name="H_RESULT"> 
        <column colName="CLOSE_FLAG"          colType="TB_STRING"    size="1"   dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="EXPNC_CLOSE_FLAG"    colType="TB_STRING"    size="1"   dec="0" keyType="TB_NORMAL" roundMode="ROUND" /> 
        <column colName="COST_CLOSE_FLAG"     colType="TB_STRING"    size="1"   dec="0" keyType="TB_NORMAL" roundMode="ROUND" />
        <column colName="YIPGO_FLAG"          colType="TB_STRING"    size="1"   dec="0" keyType="TB_NORMAL" roundMode="ROUND" />  
    </gauce>    
   
    <!-- 마스터 조회 -->
    <query name="SEL_MASTER">
        <![CDATA[
             SELECT 'F'               AS  CHECK1
                   , VA.STR_CD
                   , VA.OFFER_YM
                   , VA.OFFER_SEQ_NO
                   , VA.OFFER_DT
                   , VA.OFFER_SHEET_NO
                   , VA.BL_NO
                   , VA.PUMBUN_CD
                   , DPS.FN_GET_PUMBUN_NAME(VA.PUMBUN_CD) AS PUMBUN_NM
                   , VA.VEN_CD
                   , DPS.FN_GET_VENDOR_NAME(VA.VEN_CD) AS VEN_NM  
                   , VA.CURRENCY_CD
                   , VA.CLOSE_FLAG
                   , VA.EXPNC_CLOSE_FLAG
                   , VA.COST_CLOSE_FLAG
                   , VA.COST_CLOSE_FLAG       AS TMP_COST_CLOSE_FLAG
                   , VA.SKU_FLAG
                   , VA.SKU_TYPE
                   , SUM(VA.OFFER_TOT_QTY)    AS OFFER_TOT_QTY
                   , SUM(VA.OFFER_TOT_AMT)    AS OFFER_TOT_AMT
                   , SUM(VA.EXP_SUP_AMT)      AS EXP_SUP_AMT
                   , SUM(VA.EXP_VAT_AMT)      AS EXP_VAT_AMT
                   , SUM(VA.CHK_TOT_QTY)      AS CHK_TOT_QTY
                   , SUM(VA.OFFER_TOT_QTY) - SUM(VA.CHK_TOT_QTY) AS NOT_IN_QTY
                   , SUM(VA.CHK_EXC_TAMT)     AS CHK_EXC_TAMT
                   , SUM(VA.CHK_COST_TAMT)    AS CHK_COST_TAMT                            
                FROM (
                      SELECT TA.STR_CD
                           , TA.OFFER_YM
                           , TA.OFFER_SEQ_NO
                           , TA.OFFER_DT
                           , TA.OFFER_SHEET_NO
                           , TA.BL_NO
                           , TA.PUMBUN_CD
                           , TA.VEN_CD
                           , TA.CURRENCY_CD
                           , TA.CLOSE_FLAG
                           , TA.EXPNC_CLOSE_FLAG
                           , TA.COST_CLOSE_FLAG
                           , TD.SKU_FLAG
                           , TD.SKU_TYPE
                           , 0 AS OFFER_TOT_QTY
                           , 0 AS OFFER_TOT_AMT
                           , 0 AS EXP_SUP_AMT
                           , 0 AS EXP_VAT_AMT
                           , SUM(NVL(TC.CHK_TOT_QTY,0)) AS CHK_TOT_QTY
                           , SUM(NVL(TC.CHK_EXC_TAMT,0)) AS CHK_EXC_TAMT
                           , SUM(NVL(TC.CHK_COST_TAMT,0)) AS CHK_COST_TAMT 
                        FROM DPS.PO_OFFMST TA
                           , DPS.PO_INVMST TB
                           , DPS.PO_SLPMST TC
                           , DPS.PC_PBNMST TD
                       WHERE TA.STR_CD         = ?                
                         AND TA.OFFER_DT       BETWEEN ? AND ? 
                         AND TA.OFFER_SHEET_NO LIKE ?||'%'   
                         AND TA.PUMBUN_CD      LIKE ?||'%'         
                         AND TA.VEN_CD         LIKE ?||'%'           
                         AND TA.COST_CLOSE_FLAG     LIKE ?||'%' 
                         AND TB.STR_CD       = TA.STR_CD
                         AND TB.OFFER_YM     = TA.OFFER_YM
                         AND TB.OFFER_SEQ_NO = TA.OFFER_SEQ_NO
                         AND TC.STR_CD       = TB.STR_CD
                         AND TC.INVOICE_YM   = TB.INVOICE_YM
                         AND TC.INVOICE_SEQ_NO = TB.INVOICE_SEQ_NO
                         AND TA.PUMBUN_CD      = TD.PUMBUN_CD  
                         AND TC.SLIP_PROC_STAT = '09'      
                       GROUP BY TA.STR_CD
                              , TA.OFFER_YM
                              , TA.OFFER_SEQ_NO
                              , TA.OFFER_DT
                              , TA.OFFER_SHEET_NO
                              , TA.BL_NO
                              , TA.PUMBUN_CD
                              , TA.VEN_CD
                              , TA.CURRENCY_CD
                              , TA.CLOSE_FLAG
                              , TA.EXPNC_CLOSE_FLAG
                              , TA.COST_CLOSE_FLAG
                              , TD.SKU_FLAG
                              , TD.SKU_TYPE
                      UNION ALL    
                      SELECT TA.STR_CD
                           , TA.OFFER_YM
                           , TA.OFFER_SEQ_NO
                           , TA.OFFER_DT
                           , TA.OFFER_SHEET_NO
                           , TA.BL_NO
                           , TA.PUMBUN_CD
                           , TA.VEN_CD
                           , TA.CURRENCY_CD
                           , TA.CLOSE_FLAG
                           , TA.EXPNC_CLOSE_FLAG
                           , TA.COST_CLOSE_FLAG
                           , TD.SKU_FLAG
                           , TD.SKU_TYPE
                           , 0 AS OFFER_TOT_QTY
                           , 0 AS OFFER_TOT_AMT
                           , SUM(NVL(TB.SUP_AMT,0)) AS EXP_SUP_AMT
                           , SUM(NVL(TB.VAT_AMT,0)) AS EXP_VAT_AMT
                           , 0 AS CHK_TOT_QTY
                           , 0 AS CHK_EXC_TAMT
                           , 0 AS CHK_COST_TAMT 
                        FROM DPS.PO_OFFMST TA
                           , DPS.PO_EXPNCM TB
                           , DPS.PC_PBNMST TD
                       WHERE TA.STR_CD         = ?                
                         AND TA.OFFER_DT       BETWEEN ? AND ?  
                         AND TA.OFFER_SHEET_NO LIKE ?||'%'   
                         AND TA.PUMBUN_CD      LIKE ?||'%'        
                         AND TA.VEN_CD         LIKE ?||'%'           
                         AND TA.COST_CLOSE_FLAG     LIKE ?||'%' 
                         AND TB.STR_CD       = TA.STR_CD
                         AND TB.OFFER_YM     = TA.OFFER_YM
                         AND TB.OFFER_SEQ_NO = TA.OFFER_SEQ_NO
                         AND TA.PUMBUN_CD    = TD.PUMBUN_CD  
                       GROUP BY TA.STR_CD
                              , TA.OFFER_YM
                              , TA.OFFER_SEQ_NO
                              , TA.OFFER_DT
                              , TA.OFFER_SHEET_NO
                              , TA.BL_NO
                              , TA.PUMBUN_CD
                              , TA.VEN_CD
                              , TA.CURRENCY_CD
                              , TA.CLOSE_FLAG
                              , TA.EXPNC_CLOSE_FLAG
                              , TA.COST_CLOSE_FLAG
                              , TD.SKU_FLAG
                              , TD.SKU_TYPE
                              , TD.SKU_FLAG
                              , TD.SKU_TYPE
                      UNION ALL    
                      SELECT TA.STR_CD
                           , TA.OFFER_YM
                           , TA.OFFER_SEQ_NO
                           , TA.OFFER_DT
                           , TA.OFFER_SHEET_NO
                           , TA.BL_NO
                           , TA.PUMBUN_CD
                           , TA.VEN_CD
                           , TA.CURRENCY_CD
                           , TA.CLOSE_FLAG
                           , TA.EXPNC_CLOSE_FLAG
                           , TA.COST_CLOSE_FLAG
                           , TD.SKU_FLAG
                           , TD.SKU_TYPE
                           , SUM(NVL(TA.OFFER_TOT_QTY,0)) AS OFFER_TOT_QTY
                           , SUM(NVL(TA.OFFER_TOT_AMT,0)) AS OFFER_TOT_AMT
                           , 0 AS EXP_SUP_AMT
                           , 0 AS EXP_VAT_AMT
                           , 0 AS CHK_TOT_QTY
                           , 0 AS CHK_EXC_TAMT
                           , 0 AS CHK_COST_TAMT 
                        FROM DPS.PO_OFFMST TA
                           , DPS.PC_PBNMST TD
                       WHERE TA.STR_CD         = ?                
                         AND TA.OFFER_DT       BETWEEN ? AND ?  
                         AND TA.OFFER_SHEET_NO LIKE ?||'%'   
                         AND TA.PUMBUN_CD      LIKE ?||'%'        
                         AND TA.VEN_CD         LIKE ?||'%'           
                         AND TA.COST_CLOSE_FLAG     LIKE ?||'%' 
                         AND TA.PUMBUN_CD    = TD.PUMBUN_CD  
                       GROUP BY TA.STR_CD
                              , TA.OFFER_YM
                              , TA.OFFER_SEQ_NO
                              , TA.OFFER_DT
                              , TA.OFFER_SHEET_NO
                              , TA.BL_NO
                              , TA.PUMBUN_CD
                              , TA.VEN_CD
                              , TA.CURRENCY_CD
                              , TA.CLOSE_FLAG
                              , TA.EXPNC_CLOSE_FLAG
                              , TA.COST_CLOSE_FLAG
                              , TD.SKU_FLAG
                              , TD.SKU_TYPE
                      ) VA
                      , DPS.PC_STRPBN TA
                      , DPS.PC_STRVENMST TB
                  WHERE VA.STR_CD = TA.STR_CD
                    AND VA.PUMBUN_CD = TA.PUMBUN_CD
                    AND VA.STR_CD = TB.STR_CD
                    AND VA.VEN_CD = TB.VEN_CD
               GROUP BY VA.STR_CD
                      , VA.OFFER_YM
                      , VA.OFFER_SEQ_NO
                      , VA.OFFER_DT
                      , VA.OFFER_SHEET_NO
                      , VA.BL_NO
                      , VA.PUMBUN_CD
                      , VA.VEN_CD
                      , VA.CURRENCY_CD
                      , VA.CLOSE_FLAG
                      , VA.EXPNC_CLOSE_FLAG
                      , VA.COST_CLOSE_FLAG
                      , VA.SKU_FLAG
                      , VA.SKU_TYPE
               HAVING SUM(VA.CHK_COST_TAMT)>0
               ORDER BY VA.OFFER_DT DESC
        ]]>
    </query> 
    
     <!-- 조회 -->
    <query name="SEL_DETAIL">
        <![CDATA[
			SELECT EXC.STR_CD
			     , EXC.OFFER_YM
			     , EXC.OFFER_SEQ_NO
			     , EXC.SLIP_NO
			     , EXC.SKU_CD
			     , DPS.FN_GET_SKU_NAME(EXC.SKU_CD) AS SKU_NM   
			     , SKU.STYLE_CD
			     , SKU.COLOR_CD
			     , SKU.SIZE_CD
			     , SKU.MODEL_NO
			     , EXC.CHK_QTY
			     , EXC.CHK_EXC_AMT
			     , EXC.CHK_COST_AMT
			     , EXC.ASS_EXPENCE_AMT
			     , EXC.ASS_COST_PRC
			     , EXC.CONF_EXPENCE_AMT
			     , EXC.CONF_COST_PRC
			  FROM DPS.PO_EXCOST EXC
			     , DPS.PC_SKUMST SKU
			 WHERE EXC.STR_CD       = ?
			   AND EXC.OFFER_YM     = ?
			   AND EXC.OFFER_SEQ_NO = ?
			   AND EXC.SKU_CD = SKU.SKU_CD
        ]]>
    </query> 
    
    <!--확정 -->
    <query name="UPD_CONF">
        <![CDATA[
            UPDATE DPS.PO_OFFMST
               SET COST_CLOSE_FLAG  = ?
                 , MOD_DATE         = SYSDATE
                 , MOD_ID           = ?
             WHERE STR_CD           = ?
               AND OFFER_YM         = ?
               AND OFFER_SEQ_NO     = ?
        ]]>
    </query> 
    
    <!--확정 디테일 -->
    <query name="UPD_CONF_DETAIL">
        <![CDATA[
            UPDATE DPS.PO_EXCOST
               SET CLOSE_FLAG       = 'Y'
                 , CONF_EXPENCE_AMT = ASS_EXPENCE_AMT
                 , CONF_COST_PRC    = ASS_COST_PRC
                 , CLOSE_DT         = TO_CHAR(SYSDATE,'YYYYMMDD')
                 , MOD_DATE         = SYSDATE
                 , MOD_ID           = ?
             WHERE STR_CD           = ?
               AND OFFER_YM         = ?
               AND OFFER_SEQ_NO     = ?
        ]]>
    </query>   
    
    <!--취소 디테일 -->
    <query name="UPD_UNCONF_DETAIL">
        <![CDATA[
            UPDATE DPS.PO_EXCOST
               SET CLOSE_FLAG       = 'N'
                 , CONF_EXPENCE_AMT = 0
                 , CONF_COST_PRC    = 0
                 , CLOSE_DT         = TO_CHAR(SYSDATE,'YYYYMMDD')
                 , MOD_DATE         = SYSDATE
                 , MOD_ID           = ?
             WHERE STR_CD           = ?
               AND OFFER_YM         = ?
               AND OFFER_SEQ_NO     = ?
        ]]>
    </query>   
    
    <!--마감(확정)여부 -->
    <query name="CHECK_YN_FLAG">
        <![CDATA[
		 SELECT    MST.CLOSE_FLAG           /* 오퍼마감여부 */
                 , MST.EXPNC_CLOSE_FLAG     /* 제경비확정여부 */
                 , MST.COST_CLOSE_FLAG      /* 수입원가산정여부 */
                 , DECODE(A.YYYYMM,TO_CHAR(SYSDATE,'YYYYMM'),'Y','N') YIPGO_FLAG /*입고월이 확정월인지 여부 */
              FROM DPS.PO_OFFMST MST,
                   (SELECT MAX(SUBSTR(COS.LAST_IN_DT,1,6)) YYYYMM
                         , COS.STR_CD
                         , COS.OFFER_YM
                         , COS.OFFER_SEQ_NO
                      FROM DPS.PO_EXCOST COS
                     WHERE COS.STR_CD       = ?
                       AND COS.OFFER_YM     = ?
                       AND COS.OFFER_SEQ_NO = ? 
                  GROUP BY COS.STR_CD, COS.OFFER_YM, COS.OFFER_SEQ_NO         
                    ) A 
             WHERE MST.STR_CD       = A.STR_CD
               AND MST.OFFER_YM     = A.OFFER_YM
               AND MST.OFFER_SEQ_NO = A.OFFER_SEQ_NO
               AND MST.STR_CD       = ?
               AND MST.OFFER_YM     = ?
               AND MST.OFFER_SEQ_NO = ?
        ]]>
    </query>   
</service>